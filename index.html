<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Neuroqu√≠mico v11.0 (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Chart.js y adaptador de fecha (con versiones compatibles) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'accent': '#3b82f6',
                        'base-100': '#111827',
                        'base-200': '#1f2937',
                        'base-300': '#374151',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
        }
        .gemini-spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        [data-tooltip] { position: relative; }
        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute; bottom: 100%; left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background-color: #374151; color: #fff;
            padding: 8px 12px; border-radius: 8px;
            font-size: 0.875rem; line-height: 1.25rem;
            white-space: pre-line; width: 280px; text-align: left;
            pointer-events: none; opacity: 0;
            transition: opacity 0.2s, transform 0.2s; z-index: 10;
        }
        [data-tooltip]:hover::after { opacity: 1; transform: translateX(-50%) translateY(0); }
        #gemini-response { max-height: 20rem; overflow-y: auto; padding-right: 0.5rem; }
    </style>
</head>
<body class="bg-base-100 text-gray-200 antialiased">

    <div id="app" class="container mx-auto p-4 md:p-6 max-w-4xl">

        <div id="profile-setup" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div class="bg-base-200 rounded-2xl shadow-2xl p-8 w-full max-w-md">
                <h2 class="text-3xl font-bold text-white mb-2">Configura tu Perfil</h2>
                <p class="text-gray-400 mb-6">Tus datos se guardar√°n en la nube de Firebase.</p>
                <form id="profile-form">
                    <div class="mb-4">
                        <label for="sexo" class="block text-gray-300 mb-2 font-semibold">Sexo Biol√≥gico</label>
                        <select id="sexo" class="w-full bg-base-300 border border-gray-600 rounded-lg px-4 py-3 text-white" required>
                            <option value="Hombre">Hombre</option>
                            <option value="Mujer">Mujer</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label for="peso" class="block text-gray-300 mb-2 font-semibold">Peso Corporal (kg)</label>
                        <input type="number" id="peso" step="0.1" min="1" class="w-full bg-base-300 rounded-lg px-4 py-3 text-white" placeholder="Ej: 75" required>
                    </div>
                    <button type="submit" class="w-full bg-accent hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg">Guardar Perfil</button>
                </form>
            </div>
        </div>

        <div id="event-modal" class="fixed inset-0 z-40 items-center justify-center p-4 hidden modal-backdrop bg-black bg-opacity-75">
            <div class="bg-base-200 rounded-2xl shadow-2xl p-8 w-full max-w-md modal-content transform scale-95">
                <h2 id="event-modal-title" class="text-3xl font-bold text-white mb-6"></h2>
                <form id="event-form">
                    <div id="event-inputs-container" class="space-y-4 mb-6"></div>
                    <div class="flex gap-4">
                        <button type="button" id="cancel-event-btn" class="w-full bg-base-300 hover:bg-gray-600 text-gray-300 font-bold py-3">Cancelar</button>
                        <button type="submit" class="w-full bg-accent hover:bg-blue-500 text-white font-bold py-3">A√±adir</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="gemini-modal" class="fixed inset-0 z-40 items-center justify-center p-4 hidden modal-backdrop bg-black bg-opacity-75">
            <div class="bg-base-200 rounded-2xl shadow-2xl p-8 w-full max-w-md modal-content transform scale-95">
                <h2 class="text-3xl font-bold text-white mb-6">An√°lisis IA</h2>
                <div id="gemini-loading" class="flex flex-col items-center justify-center h-40">
                    <div class="gemini-spinner"></div>
                    <p class="mt-4 text-gray-400">Analizando tu estado...</p>
                </div>
                <div id="gemini-response" class="text-gray-300 prose prose-invert max-w-none hidden"></div>
                <button type="button" id="close-gemini-btn" class="w-full mt-6 bg-base-300 hover:bg-gray-600 text-gray-300 font-bold py-3">Cerrar</button>
            </div>
        </div>

        <div id="api-key-modal" class="fixed inset-0 z-50 items-center justify-center p-4 hidden modal-backdrop bg-black bg-opacity-75">
            <div class="bg-base-200 rounded-2xl shadow-2xl p-8 w-full max-w-md modal-content transform scale-95">
                <h2 class="text-3xl font-bold text-white mb-2">API Key de Gemini</h2>
                <p class="text-gray-400 mb-6">Para usar el an√°lisis con IA, necesitas una API Key de Google AI Studio. Es gratis.</p>
                <form id="api-key-form">
                    <div class="mb-4">
                        <label for="api-key-input" class="block text-gray-300 mb-2 font-semibold">Tu API Key</label>
                        <input type="password" id="api-key-input" class="w-full bg-base-300 border border-gray-600 rounded-lg px-4 py-3 text-white" required>
                    </div>
                     <p class="text-xs text-gray-500 mb-4">La clave se guardar√° √∫nicamente en tu navegador. <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-accent hover:underline">Obt√©n una aqu√≠.</a></p>
                    <div class="flex gap-4">
                         <button type="button" id="cancel-api-key-btn" class="w-full bg-base-300 hover:bg-gray-600 text-gray-300 font-bold py-3">Cancelar</button>
                        <button type="submit" class="w-full bg-accent hover:bg-blue-500 text-white font-bold py-3">Guardar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="main-app" class="hidden">
            <header class="flex justify-between items-start mb-6">
                <div>
                    <h1 class="text-4xl font-extrabold text-white">Neuro-√çndice</h1>
                    <div id="user-id-display" class="text-xs text-gray-500 font-mono mt-1"></div>
                </div>
                <button id="edit-profile-btn" class="bg-base-200 hover:bg-base-300 text-gray-300 font-semibold py-2 px-4 rounded-lg">Perfil</button>
            </header>

            <div class="bg-base-200 p-8 rounded-2xl shadow-xl mb-6 text-center">
                 <div class="flex justify-center items-baseline gap-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-400 mb-2">√çndice Actual</h3>
                        <div id="current-index" class="text-8xl font-black text-white">100</div>
                    </div>
                    <div>
                         <h3 class="text-base font-semibold text-gray-400 mb-2">L√≠nea Base</h3>
                         <div id="base-level-display" class="text-4xl font-bold text-accent">100</div>
                    </div>
                </div>
                 <div id="sleep-debt-indicator" class="text-red-400 font-semibold mt-2 hidden"></div>
            </div>

            <div class="bg-base-200 p-4 md:p-6 rounded-2xl shadow-xl mb-6 h-96">
                <h3 class="text-2xl font-bold text-white mb-4">Evoluci√≥n y Previsi√≥n</h3>
                <canvas id="neuro-chart"></canvas>
            </div>

            <div class="bg-base-200 p-6 rounded-2xl shadow-xl mb-6">
                <h3 class="text-2xl font-bold text-white mb-4">An√°lisis IA</h3>
                <p class="text-gray-400 mb-4">Obt√©n una interpretaci√≥n de tu estado actual y una recomendaci√≥n con la IA de Gemini.</p>
                <button id="analyze-gemini-btn" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white font-bold py-3 rounded-lg">
                    ‚ú® Analizar mi Estado
                </button>
            </div>

            <div class="bg-base-200 p-6 rounded-2xl shadow-xl mb-6">
                <h3 class="text-2xl font-bold text-white mb-4">¬øC√≥mo te sientes ahora?</h3>
                <div class="flex items-center gap-4">
                     <span class="text-lg">üò©</span>
                     <input type="range" id="sensacion-slider" min="1" max="10" value="5" class="w-full h-3 bg-base-300 rounded-lg appearance-none">
                     <span class="text-lg">üòÑ</span>
                </div>
                 <div class="text-center mt-2">
                    <span id="sensacion-value" class="font-bold text-accent text-lg">5</span> / 10
                 </div>
                <button id="add-sensacion-btn" class="w-full mt-4 bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg">Registrar Sensaci√≥n</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-base-200 p-6 rounded-2xl shadow-xl">
                    <h3 class="text-2xl font-bold text-white mb-4">A√±adir Evento</h3>
                    <div class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                        <button data-event="sue√±o" class="event-btn bg-indigo-600 hover:bg-indigo-700 col-span-1 lg:col-span-3" data-tooltip="Efecto: (+/-) seg√∫n horas (>4h) y calidad.&#x000A;Duraci√≥n: 24h.&#x000A;Bono por 8h buenas: +12.">Sue√±o</button>
                        <button data-event="hrv" class="event-btn bg-cyan-600 hover:bg-cyan-700" data-tooltip="Efecto: Modificador temporal seg√∫n valor.&#x000A;Duraci√≥n: 3h.&#x000A;Ej: 80ms = +7.5.">HRV</button>
                        <button data-event="ejercicio" class="event-btn bg-emerald-500 hover:bg-emerald-600" data-tooltip="Efecto: Pico positivo seg√∫n intensidad.&#x000A;Duraci√≥n: Sesi√≥n + 2h.&#x000A;Ej: 30min medio = +10.">Ejercicio</button>
                        <button data-event="alcohol" class="event-btn bg-purple-600 hover:bg-purple-700" data-tooltip="Efecto: Pico +8/ud, Baj√≥n -16/ud.&#x000A;Duraci√≥n: 6h.&#x000A;Ajustado por sexo y peso.">Alcohol</button>
                        <button data-event="modafinilo" class="event-btn bg-sky-500 hover:bg-sky-600" data-tooltip="Efecto: +35 por 100mg.&#x000A;Duraci√≥n: ~17h.&#x000A;Ajustado por sexo y peso.">Modafinilo</button>
                        <button data-event="cafeina" class="event-btn bg-yellow-700 hover:bg-yellow-800" data-tooltip="Efecto: Pico +20/taza, Baj√≥n -5/taza.&#x0F;Duraci√≥n: 4h.">Cafe√≠na</button>
                        <button data-event="te" class="event-btn bg-lime-600 hover:bg-lime-700" data-tooltip="Efecto: Pico +12/taza, Baj√≥n -2/taza.&#x000A;Duraci√≥n: 5h.">T√©</button>
                        <button data-event="azucar" class="event-btn bg-gray-400 hover:bg-gray-500" data-tooltip="Efecto: Pico +25, Baj√≥n -15 (medio).&#x000A;Duraci√≥n: 2h.">Az√∫car</button>
                        <button data-event="porno" class="event-btn bg-orange-500 hover:bg-orange-600" data-tooltip="Efecto: Pico variable, Baj√≥n -10.&#x000A;Duraci√≥n: Sesi√≥n + 1.5h.">Porno</button>
                        <button data-event="masturbacion" class="event-btn bg-pink-500 hover:bg-pink-600" data-tooltip="Efecto: Pico +15, Baj√≥n -5.&#x000A;Duraci√≥n: Sesi√≥n + 50min.">Masturbaci√≥n</button>
                        <button data-event="orgasmo" class="event-btn bg-rose-600 hover:bg-rose-700" data-tooltip="Efecto: Pico +40 (3min), Baj√≥n -20.&#x000A;Duraci√≥n: 2.5h.">Orgasmo</button>
                    </div>
                </div>

                <div class="bg-base-200 p-6 rounded-2xl shadow-xl">
                    <h3 class="text-2xl font-bold text-white mb-4">Eventos Activos</h3>
                    <div id="active-events" class="space-y-3 max-h-60 overflow-y-auto">
                        <p id="no-events-msg" class="text-gray-400">Sin eventos activos.</p>
                    </div>
                </div>
            </div>

            <div class="bg-base-200 p-6 rounded-2xl shadow-xl mt-6">
                <h3 class="text-2xl font-bold text-white mb-4">Presupuesto Semanal</h3>
                <div id="weekly-budget-tracker" class="space-y-2 text-gray-300"></div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                <div class="bg-base-200 p-6 rounded-2xl shadow-xl">
                    <h3 class="text-2xl font-bold text-white mb-4">Estad√≠sticas</h3>
                    <div id="stats-container" class="space-y-2 text-gray-300">
                        <p>Media Ayer: <span id="avg-yesterday" class="font-bold text-accent">--</span></p>
                        <p>Media √öltimos 7 D√≠as: <span id="avg-week" class="font-bold text-accent">--</span></p>
                        <p>Media Total: <span id="avg-total" class="font-bold text-accent">--</span></p>
                    </div>
                </div>
                <div class="bg-base-200 p-6 rounded-2xl shadow-xl">
                    <h3 class="text-2xl font-bold text-white mb-4">D√≠as de Abstinencia</h3>
                    <div id="abstinence-container" class="space-y-2 text-gray-300">
                        <p>Alcohol: <span id="abstinence-alcohol" class="font-bold text-accent">--</span> d√≠as</p>
                        <p>Porno/Masturb.: <span id="abstinence-sexual" class="font-bold text-accent">--</span> d√≠as</p>
                        <p>Az√∫car: <span id="abstinence-sugar" class="font-bold text-accent">--</span> d√≠as</p>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, onSnapshot, query, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const App = {
                state: { 
                    userProfile: null, 
                    events: [], 
                    currentIndex: 100, 
                    currentEventType: null, 
                    chart: null, 
                    userId: null, 
                    apiKeyPromise: null,
                    firebase: {}, // Almacenar√° instancias de Firebase
                    appId: 'default-app-id' // ID de la app
                },
                ui: {},
                
                init() {
                    this.ui = {
                        profileSetup: document.getElementById('profile-setup'),
                        mainApp: document.getElementById('main-app'),
                        profileForm: document.getElementById('profile-form'),
                        sexoInput: document.getElementById('sexo'),
                        pesoInput: document.getElementById('peso'),
                        editProfileBtn: document.getElementById('edit-profile-btn'),
                        currentIndexDisplay: document.getElementById('current-index'),
                        baseLevelDisplay: document.getElementById('base-level-display'),
                        chartCanvas: document.getElementById('neuro-chart'),
                        sleepDebtIndicator: document.getElementById('sleep-debt-indicator'),
                        activeEventsContainer: document.getElementById('active-events'),
                        noEventsMsg: document.getElementById('no-events-msg'),
                        eventModal: document.getElementById('event-modal'),
                        eventModalTitle: document.getElementById('event-modal-title'),
                        eventForm: document.getElementById('event-form'),
                        eventInputsContainer: document.getElementById('event-inputs-container'),
                        cancelEventBtn: document.getElementById('cancel-event-btn'),
                        sensacionSlider: document.getElementById('sensacion-slider'),
                        sensacionValue: document.getElementById('sensacion-value'),
                        addSensacionBtn: document.getElementById('add-sensacion-btn'),
                        analyzeGeminiBtn: document.getElementById('analyze-gemini-btn'),
                        geminiModal: document.getElementById('gemini-modal'),
                        geminiLoading: document.getElementById('gemini-loading'),
                        geminiResponse: document.getElementById('gemini-response'),
                        closeGeminiBtn: document.getElementById('close-gemini-btn'),
                        userIdDisplay: document.getElementById('user-id-display'),
                        apiKeyModal: document.getElementById('api-key-modal'),
                        apiKeyForm: document.getElementById('api-key-form'),
                        apiKeyInput: document.getElementById('api-key-input'),
                        cancelApiKeyBtn: document.getElementById('cancel-api-key-btn'),
                        weeklyBudgetTracker: document.getElementById('weekly-budget-tracker'),
                        statsContainer: document.getElementById('stats-container'),
                        abstinenceContainer: document.getElementById('abstinence-container'),
                        avgYesterday: document.getElementById('avg-yesterday'),
                        avgWeek: document.getElementById('avg-week'),
                        avgTotal: document.getElementById('avg-total'),
                        abstinenceAlcohol: document.getElementById('abstinence-alcohol'),
                        abstinenceSexual: document.getElementById('abstinence-sexual'),
                        abstinenceSugar: document.getElementById('abstinence-sugar'),
                    };
                    
                    document.querySelectorAll('.event-btn').forEach(btn => {
                        btn.className += ' text-white font-bold py-3 px-4 rounded-lg transition duration-300';
                    });
                    
                    this.attachEventListeners();
                    this.initFirebase(); // Iniciar Firebase
                },
                
                async initFirebase() {
                    try {
                        this.state.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        
                        // ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è
                        // ======================================================================
                        // ! IMPORTANTE: PEGA TU CONFIGURACI√ìN DE FIREBASE (PASO 3 DE LA GU√çA) AQU√ç
                        // Reemplaza 'null' con el bloque const firebaseConfig = { ... };
                        // ======================================================================
                        
                        const firebaseConfig = {
                          apiKey: "AIzaSyBYCR_uYoR5yFR1bOjNnnBBKXMz7Mx03ng",
                          authDomain: "neuro-indice.firebaseapp.com",
                          projectId: "neuro-indice",
                          storageBucket: "neuro-indice.firebasestorage.app",
                          messagingSenderId: "535634519507",
                          appId: "1:535634519507:web:67b2579b7953941561fb26",
                          measurementId: "G-YF7S907YT4"
                        };
                        
                        // Initialize Firebase
                        const app = initializeApp(firebaseConfig);
                        const analytics = getAnalytics(app);

                        // ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è
                        

                        if (!firebaseConfig) {
                            if (typeof __firebase_config !== 'undefined') {
                                // Fallback para el entorno de desarrollo (si existe)
                                const fbConfig = JSON.parse(__firebase_config);
                                const app = initializeApp(fbConfig);
                                this.state.firebase = { app, auth: getAuth(app), db: getFirestore(app) };
                            } else {
                                console.error("Firebase config not found.");
                                document.body.innerHTML = '<div class="text-white text-center p-8">Error de configuraci√≥n: No se pudo conectar a la base de datos. Pega tu `firebaseConfig` en el archivo index.html.</div>';
                                return;
                            }
                        } else {
                             const app = initializeApp(firebaseConfig);
                             this.state.firebase = { app, auth: getAuth(app), db: getFirestore(app) };
                        }
                        
                        const auth = this.state.firebase.auth;

                        onAuthStateChanged(auth, async (user) => {
                            if (user) {
                                this.state.userId = user.uid;
                                this.ui.userIdDisplay.textContent = `ID Sesi√≥n: ${user.uid.substring(0, 8)}...`;
                                await this.loadProfile();
                                if (this.state.userProfile) {
                                    this.startApp();
                                } else {
                                    this.ui.profileSetup.classList.remove('hidden');
                                }
                            }
                        });
                        
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Initialization Error:", error);
                        alert("No se pudo inicializar la aplicaci√≥n.");
                    }
                },

                async startApp() {
                    this.ui.profileSetup.classList.add('hidden');
                    this.ui.mainApp.classList.remove('hidden');
                    this.setupEventListeners(); // Mover aqu√≠ para que los eventos se carguen
                    await this.checkAndApplyRecovery();
                    this.initChart();
                    this.update();
                    setInterval(() => this.update(), 60000); 
                },

                setupEventListeners() {
                    const { db, appId, userId } = this.state.firebase;
                    if (!db || !appId || !userId) {
                        console.error("Firebase no est√° listo. No se pueden cargar eventos.");
                        return;
                    }
                    const eventsQuery = query(collection(db, `artifacts/${this.state.appId}/users/${this.state.userId}/events`));
                    onSnapshot(eventsQuery, (snapshot) => {
                        this.state.events = snapshot.docs.map(doc => {
                            const data = doc.data();
                            return {
                                ...data,
                                id: doc.id,
                                startTime: data.startTime.toDate ? data.startTime.toDate().toISOString() : data.startTime
                            };
                        });
                        this.update();
                    });
                },

                async loadProfile() {
                    const { db, userId, appId } = this.state.firebase;
                    if (!db || !userId || !appId) return;
                    
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/profile/main`);
                    try {
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            const profileData = docSnap.data();
                            this.state.userProfile = {
                                ...profileData,
                                dynamicBaseLevel: profileData.dynamicBaseLevel || 100,
                                lastRecoveryTimestamp: profileData.lastRecoveryTimestamp ? profileData.lastRecoveryTimestamp.toDate().toISOString() : null
                            };
                            this.ui.sexoInput.value = this.state.userProfile.sexo;
                            this.ui.pesoInput.value = this.state.userProfile.peso;
                        } else {
                            this.state.userProfile = null;
                        }
                    } catch (e) {
                        console.error("Error al cargar perfil:", e);
                        this.state.userProfile = null;
                    }
                },
                
                async saveProfile(e) {
                    e.preventDefault();
                    const { db, userId, appId } = this.state.firebase;
                    const pesoValue = parseFloat(this.ui.pesoInput.value);
                    if (pesoValue <= 0) return;

                    const wasFirstTime = !this.state.userProfile;
                    const userProfileData = {
                        sexo: this.ui.sexoInput.value,
                        peso: pesoValue,
                        dynamicBaseLevel: wasFirstTime ? 100 : this.state.userProfile.dynamicBaseLevel,
                        lastRecoveryTimestamp: wasFirstTime ? null : this.state.userProfile.lastRecoveryTimestamp,
                    };
                    this.state.userProfile = userProfileData;
                    
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/profile/main`);
                    await setDoc(docRef, userProfileData);

                    if (wasFirstTime) { this.startApp(); } 
                    else {
                        this.ui.profileSetup.classList.add('hidden');
                        this.update();
                    }
                },
                                
                async addEvent(type, params = {}, startTime = new Date()) {
                    const { db, userId, appId } = this.state.firebase;
                    
                    if (type === 'sue√±o') {
                        const qualityMap = { 1.5: 0.1, 1.0: 0.05, 0.5: -0.1 }; // Good, Regular, Bad
                        const qualityFactor = qualityMap[params.intensidad] || 0;
                        this.state.userProfile.dynamicBaseLevel += qualityFactor;
                        this.state.userProfile.dynamicBaseLevel = Math.min(this.state.userProfile.dynamicBaseLevel, 100);
                        
                        // "Reset" by filtering events *before* adding the new sleep event
                        const sleepStartTime = startTime.getTime();
                        this.state.events = this.state.events.filter(event => new Date(event.startTime).getTime() >= sleepStartTime);
                    }
                    
                    const newEvent = { id: Date.now(), type, params, startTime: startTime }; // Guardar como objeto Date de JS
                    
                    const budgets = {
                        alcohol: { limit: 6, penalty: 0.08, types: ['alcohol'] },
                        sexual: { limit: 0, penalty: 0.1, types: ['porno', 'masturbacion'] },
                        azucar: { limit: 6, penalty: 0.03, types: ['azucar']}
                    };

                    let budgetCategory = null;
                    for (const category in budgets) {
                        if (budgets[category].types.includes(type)) {
                            budgetCategory = category;
                            break;
                        }
                    }

                    if (budgetCategory) {
                        const categoryInfo = budgets[budgetCategory];
                        // +1 for the current event
                        const count = this.getEventCountInWindow(categoryInfo.types, 7 * 24) + 1; 
                        if (count > categoryInfo.limit) {
                            this.state.userProfile.dynamicBaseLevel -= categoryInfo.penalty;
                        }
                    }

                    // Add to local state first for immediate UI update
                    this.state.events.push({ ...newEvent, startTime: newEvent.startTime.toISOString() });
                    this.saveEvents(); // Save to local storage (for temp persistence)
                    
                    // Save to Firebase
                    const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/events`);
                    await addDoc(collectionRef, { ...newEvent, createdAt: serverTimestamp() });
                    await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/profile/main`), {
                        dynamicBaseLevel: this.state.userProfile.dynamicBaseLevel
                    });
                    
                    this.update();
                },

                async checkAndApplyRecovery() {
                    if (!this.state.userProfile || this.state.userProfile.dynamicBaseLevel >= 100) return;
                    const { db, userId, appId } = this.state.firebase;

                    const budgets = {
                        alcohol: { limit: 6, types: ['alcohol'] },
                        sexual: { limit: 0, types: ['porno', 'masturbacion'] },
                        azucar: { limit: 6, types: ['azucar']}
                    };
                    
                    let hasExceededBudget = false;
                    for (const category in budgets) {
                        const count = this.getEventCountInWindow(budgets[category].types, 7 * 24);
                        if (count > budgets[category].limit) {
                            hasExceededBudget = true;
                            break;
                        }
                    }
                    
                    if (!hasExceededBudget) {
                        const lastRecoveryTime = this.state.userProfile.lastRecoveryTimestamp ? new Date(this.state.userProfile.lastRecoveryTimestamp).getTime() : 0;
                        const now = Date.now();
                        const hoursSinceLastRecovery = (now - lastRecoveryTime) / 3600000;

                        if (hoursSinceLastRecovery >= 24) {
                            const daysToRecover = Math.floor(hoursSinceLastRecovery / 24);
                            const recoveryAmount = daysToRecover * 0.2;
                            
                            let newBaseLevel = this.state.userProfile.dynamicBaseLevel + recoveryAmount;
                            newBaseLevel = Math.min(newBaseLevel, 100);

                            this.state.userProfile.dynamicBaseLevel = newBaseLevel;
                            this.state.userProfile.lastRecoveryTimestamp = new Date().toISOString();
                            
                            await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/profile/main`), {
                                dynamicBaseLevel: newBaseLevel,
                                lastRecoveryTimestamp: serverTimestamp()
                            });
                        }
                    }
                },
                
                getEventCountInWindow(types, windowHours) {
                    const now = Date.now();
                    const windowStart = now - (windowHours * 3600000);
                    return this.state.events.filter(event => 
                        types.includes(event.type) && new Date(event.startTime).getTime() >= windowStart
                    ).length;
                },

                handleEventSubmit(e) {
                    e.preventDefault();
                    const params = {};
                    ['cantidad', 'intensidad'].forEach(p => {
                        const input = document.getElementById(`param-${p}`);
                        if (input) params[p] = (input.type === 'number') ? parseFloat(input.value) : input.value;
                    });
                    const dateValue = document.getElementById('param-date').value;
                    const timeValue = document.getElementById('param-time').value;
                    const eventStartTime = new Date(`${dateValue}T${timeValue}`);
                    this.addEvent(this.state.currentEventType, params, eventStartTime);
                    this.closeEventModal();
                },
                
                calculateSleepDebt(now) {
                    const sleepEvents = this.state.events
                        .filter(e => e.type === 'sue√±o')
                        .sort((a, b) => new Date(b.startTime) - new Date(a.startTime));

                    if (sleepEvents.length === 0) return 0; 

                    const lastSleep = sleepEvents[0];
                    const lastSleepStart = new Date(lastSleep.startTime).getTime();
                    const lastSleepDurationHours = lastSleep.params.cantidad || 0;
                    const lastSleepEnd = lastSleepStart + (lastSleepDurationHours * 3600000); 

                    const hoursSinceWaking = (now - lastSleepEnd) / 3600000;
                    
                    const awakeThreshold = 18;
                    if (hoursSinceWaking > awakeThreshold) {
                        const deprivationHours = Math.floor(hoursSinceWaking - awakeThreshold);
                        const penalty = deprivationHours * 0.5;
                        return -penalty;
                    }
                    return 0;
                },

                update() {
                    try {
                        if (!this.state.userProfile) return;
                        
                        const allPoints = this.generateAllChartPoints();

                        this.updateStatsAndAbstinence(allPoints);

                        const factors = this.calculateFactors();
                        let totalEffectNow = 0;
                        const now = Date.now();
                        
                        this.state.events.forEach(event => {
                            const effectResult = this.getEventEffect(event, factors, now);
                            totalEffectNow += effectResult.effect;
                        });

                        const sleepDebt = this.calculateSleepDebt(now);
                        totalEffectNow += sleepDebt;
                        
                        const displayEvents = this.state.events.filter(event => !this.getEventEffect(event, factors, now).finished);
                        
                        this.state.currentIndex = Math.round(this.state.userProfile.dynamicBaseLevel + totalEffectNow);
                        
                        this.updateUI(displayEvents, sleepDebt);
                        this.updateChart(allPoints);
                    } catch (error) {
                        console.error("Update cycle error:", error);
                    }
                },
                
                updateStatsAndAbstinence(allPoints) {
                    const now = new Date();
                    const yesterday = new Date(now);
                    yesterday.setDate(now.getDate() - 1);
                    const weekAgo = new Date(now);
                    weekAgo.setDate(now.getDate() - 7);
                    
                    const yesterdayStart = new Date(yesterday).setHours(0,0,0,0);
                    const yesterdayEnd = new Date(yesterday).setHours(23,59,59,999);

                    const yesterdayPoints = allPoints.filter(p => p.x >= yesterdayStart && p.x <= yesterdayEnd);
                    const weekPoints = allPoints.filter(p => p.x >= weekAgo.getTime());

                    const avg = (points) => points.length > 0 ? (points.reduce((sum, p) => sum + p.y, 0) / points.length).toFixed(1) : '--';

                    this.ui.avgYesterday.textContent = avg(yesterdayPoints);
                    this.ui.avgWeek.textContent = avg(weekPoints);
                    this.ui.avgTotal.textContent = avg(allPoints.filter(p => p.x <= now.getTime()));

                    const lastEventDate = (types) => {
                        const relevantEvents = this.state.events
                            .filter(e => types.includes(e.type))
                            .sort((a,b) => new Date(b.startTime) - new Date(a.startTime));
                        return relevantEvents.length > 0 ? new Date(relevantEvents[0].startTime) : null;
                    };

                    const daysSince = (date) => {
                        if (!date) return '‚àû';
                        return Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24));
                    };

                    this.ui.abstinenceAlcohol.textContent = `${daysSince(lastEventDate(['alcohol']))} d√≠as`;
                    this.ui.abstinenceSexual.textContent = `${daysSince(lastEventDate(['porno', 'masturbacion']))} d√≠as`;
                    this.ui.abstinenceSugar.textContent = `${daysSince(lastEventDate(['azucar']))} d√≠as`;
                },

                updateUI(displayEvents, sleepDebt) {
                    this.ui.userIdDisplay.textContent = `ID Sesi√≥n: ${this.state.userId ? this.state.userId.substring(0, 8) : 'Cargando'}...`;
                    this.ui.currentIndexDisplay.textContent = this.state.currentIndex;
                    this.ui.baseLevelDisplay.textContent = this.state.userProfile.dynamicBaseLevel.toFixed(2);
                    
                    if (sleepDebt < 0) {
                        this.ui.sleepDebtIndicator.textContent = `Deuda de Sue√±o: ${sleepDebt.toFixed(1)} pts`;
                        this.ui.sleepDebtIndicator.classList.remove('hidden');
                    } else {
                        this.ui.sleepDebtIndicator.classList.add('hidden');
                    }

                    const alcoholCount = this.getEventCountInWindow(['alcohol'], 7 * 24);
                    const sexualCount = this.getEventCountInWindow(['porno', 'masturbacion'], 7 * 24);
                    const azucarCount = this.getEventCountInWindow(['azucar'], 7 * 24);
                    const debt = 100 - this.state.userProfile.dynamicBaseLevel;
                    const daysToRecover = debt > 0 ? Math.ceil(debt / 0.2) : 0;

                    this.ui.weeklyBudgetTracker.innerHTML = `
                        <p>Alcohol (7 d√≠as): <span class="font-bold ${alcoholCount > 6 ? 'text-red-400' : 'text-green-400'}">${alcoholCount} / 6</span></p>
                        <p>Porno/Masturb. (7 d√≠as): <span class="font-bold ${sexualCount > 0 ? 'text-red-400' : 'text-green-400'}">${sexualCount} / 0</span></p>
                        <p>Az√∫car (7 d√≠as): <span class="font-bold ${azucarCount > 6 ? 'text-red-400' : 'text-green-400'}">${azucarCount} / 6</span></p>
                        ${daysToRecover > 0 ? `<p class="mt-2 text-sm text-gray-400">D√≠as estimados para recuperar base a 100 (con abstinencia): <span class="font-bold text-accent">${daysToRecover}</span></p>` : ''}
                    `;

                    const base = this.state.userProfile.dynamicBaseLevel;
                    if (this.state.currentIndex > base + 15) this.ui.currentIndexDisplay.style.color = '#22c55e';
                    else if (this.state.currentIndex > base + 5) this.ui.currentIndexDisplay.style.color = '#a3e635';
                    else if (this.state.currentIndex < base - 15) this.ui.currentIndexDisplay.style.color = '#ef4444';
                    else if (this.state.currentIndex < base - 5) this.ui.currentIndexDisplay.style.color = '#f97316';
                    else this.ui.currentIndexDisplay.style.color = '#ffffff';

                    this.ui.activeEventsContainer.innerHTML = '';
                    if (displayEvents.length === 0) {
                        this.ui.activeEventsContainer.innerHTML = '<p class="text-gray-400">Sin eventos activos.</p>';
                    } else {
                        displayEvents.sort((a,b) => new Date(b.startTime) - new Date(a.startTime)).forEach(event => {
                            const eventEl = document.createElement('div');
                            eventEl.className = 'bg-base-300 p-3 rounded-lg flex justify-between items-center';
                            let details = '';
                            if (event.params.cantidad) {
                                let unit = '';
                                if (['modafinilo'].includes(event.type)) unit = 'mg';
                                else if (['ejercicio', 'porno', 'masturbacion'].includes(event.type)) unit = 'min';
                                else if (event.type === 'alcohol') unit = 'uds';
                                else if (event.type === 'sue√±o') unit = 'h';
                                else if (event.type === 'hrv') unit = 'ms';
                                else if (['cafeina', 'te'].includes(event.type)) unit = 'tazas';
                                details += `${details ? ': ' : ''}${event.params.cantidad} ${unit}`;
                            }
                            if (event.params.intensidad) {
                                const qualityMap = {0.5:'Mala', 1.0:'Regular', 1.5:'Buena'};
                                const intensityMap = {0.5:'Baja', 0.7:'Baja', 1.0:'Media', 1.5:'Alta', 2.0:'Alta'};
                                const text = qualityMap[event.params.intensidad] || intensityMap[event.params.intensidad] || '';
                                details += ` (${text})`;
                            }
                            const timeSince = (Date.now() - new Date(event.startTime).getTime()) / 60000;
                            const timeString = timeSince < 60 ? `${Math.round(timeSince)}m` : `${(timeSince/60).toFixed(1)}h`;
                            eventEl.innerHTML = `<div><span class="font-bold capitalize">${(event.type || '').replace('cafeina', 'Cafe√≠na')}</span><span class="text-sm text-gray-400 ml-2">${details}</span></div> <span class="text-sm font-mono text-gray-400">hace ${timeString}</span>`;
                            this.ui.activeEventsContainer.appendChild(eventEl);
                        });
                    }
                },

                getApiKey() {
                    return new Promise((resolve) => {
                        const savedKey = localStorage.getItem('geminiApiKey_v10');
                        if (savedKey) {
                            resolve(savedKey);
                            return;
                        }
                        
                        this.ui.apiKeyModal.classList.add('flex');
                        this.ui.apiKeyModal.classList.remove('hidden');

                        const handleSubmit = (e) => {
                            e.preventDefault();
                            const apiKey = this.ui.apiKeyInput.value;
                            if (apiKey) {
                                localStorage.setItem('geminiApiKey_v10', apiKey);
                                cleanup();
                                resolve(apiKey);
                            }
                        };

                        const handleCancel = () => {
                            cleanup();
                            resolve(null);
                        };

                        const cleanup = () => {
                            this.ui.apiKeyModal.classList.add('hidden');
                            this.ui.apiKeyModal.classList.remove('flex');
                            this.ui.apiKeyForm.removeEventListener('submit', handleSubmit);
                            this.ui.cancelApiKeyBtn.removeEventListener('click', handleCancel);
                        };

                        this.ui.apiKeyForm.addEventListener('submit', handleSubmit);
                        this.ui.cancelApiKeyBtn.addEventListener('click', handleCancel);
                    });
                },

                async handleGeminiAnalysis() {
                    this.ui.geminiModal.classList.add("flex");
                    this.ui.geminiModal.classList.remove("hidden");
                    this.ui.geminiResponse.classList.add("hidden");
                    this.ui.geminiLoading.classList.remove("hidden");
                    
                    const response = await this.callGeminiAPI();

                    this.ui.geminiLoading.classList.add("hidden");
                    this.ui.geminiResponse.classList.remove("hidden");
                    this.ui.geminiResponse.textContent = response;
                },

                async callGeminiAPI() {
                    const apiKey = await this.getApiKey();
                    if (!apiKey) {
                        return "An√°lisis cancelado. Se necesita una API Key de Gemini para continuar.";
                    }

                    const systemPrompt = "Eres un asistente experto en neuroqu√≠mica y bienestar. Tu tono es informativo, cient√≠fico pero accesible y emp√°tico. No eres un m√©dico, sino un int√©rprete de un modelo te√≥rico. Explicas el estado actual y el impacto a largo plazo en la l√≠nea base.";
                    const now = Date.now();
                    const factors = this.calculateFactors();
                    const activeEvents = this.state.events.filter(event => !this.getEventEffect(event, factors, now).finished);
                    let eventsSummary = activeEvents.length > 0 ? activeEvents.map(event => `- Evento: ${event.type}, iniciado hace ${((now - new Date(event.startTime).getTime()) / 3600000).toFixed(1)} horas.`).join('\n') : "No hay eventos activos.";
                    const userQuery = `Mi perfil fisiol√≥gico es: Sexo ${this.state.userProfile.sexo}, Peso ${this.state.userProfile.peso} kg. Mi estado actual es: - Neuro-√çndice Actual: ${this.state.currentIndex} - L√≠nea Base Din√°mica: ${this.state.userProfile.dynamicBaseLevel.toFixed(2)}. Contexto importante: La L√≠nea Base (homeostasis) ideal es 100. Mi l√≠nea base actual se ha ajustado por h√°bitos a largo plazo. El √çndice Actual es la suma de la L√≠nea Base y los efectos temporales de los eventos. Un √çndice de ${this.state.currentIndex} sobre una base de ${this.state.userProfile.dynamicBaseLevel.toFixed(2)} significa un estado temporal de ${ (this.state.currentIndex - this.state.userProfile.dynamicBaseLevel).toFixed(0) } puntos. Eventos activos que influyen en el √≠ndice: ${eventsSummary}. Basado en estos datos, proporciona un an√°lisis en dos p√°rrafos: 1. **An√°lisis del Momento:** Explica mi estado actual (el Neuro-√çndice de ${this.state.currentIndex}) como resultado de los eventos activos y su efecto sobre mi l√≠nea base. 2. **An√°lisis a Largo Plazo:** Comenta sobre mi L√≠nea Base de ${this.state.userProfile.dynamicBaseLevel.toFixed(2)}. Explica si est√° por debajo de 100, por qu√© podr√≠a ser, y da una sugerencia pr√°ctica y espec√≠fica para ayudar a recuperarla hacia 100. Tu sugerencia para recuperarla DEBE centrarse exclusivamente en la gesti√≥n de los eventos que, seg√∫n el modelo, penalizan la l√≠nea base (alcohol, porno, masturbaci√≥n, az√∫car) dentro de sus presupuestos semanales, y en la calidad del sue√±o. No des consejos gen√©ricos como tomar el sol o meditar. S√© directo y enf√≥cate en las reglas del modelo. No uses markdown.`;
                    
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                    const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, };
                    
                    try {
                        let response;
                        for (let i = 0; i < 5; i++) {
                            response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                            if (response.ok) break;
                            if (response.status === 400 || response.status === 403) {
                                localStorage.removeItem('geminiApiKey_v10');
                                return "Error de autenticaci√≥n. Tu API Key parece incorrecta. La hemos borrado para que puedas introducirla de nuevo la pr√≥xima vez.";
                            }
                            await new Promise(resolve => setTimeout(resolve, 2**i * 1000));
                        }
                        if (!response.ok) throw new Error(`API request failed: ${response.status}`);
                        const result = await response.json();
                        return result.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo obtener una respuesta de la IA.";
                    } catch (error) {
                        console.error("Error calling Gemini API:", error);
                        return "Error al conectar con el servicio de IA. Verifica tu API Key o int√©ntalo m√°s tarde.";
                    }
                },
                
                initChart() {
                    const ctx = this.ui.chartCanvas.getContext('2d');
                    this.state.chart = new Chart(ctx, {
                        type: 'line', 
                        data: { 
                            datasets: [
                                { label: 'Historial', data: [], borderColor: '#3b82f6', borderWidth: 3, pointRadius: 0, tension: 0.4 }, 
                                { label: 'Previsi√≥n', data: [], borderColor: '#60a5fa', borderWidth: 2, pointRadius: 0, tension: 0.4, borderDash: [5, 5] },
                                { label: 'Media M√≥vil (24h)', data: [], borderColor: '#f97316', borderWidth: 2, pointRadius: 0, tension: 0.4, borderDash: [2, 2] }
                            ] 
                        },
                        options: { parsing: false, responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day', displayFormats: { day: 'dd MMM' }, tooltipFormat: 'dd MMM, HH:mm' }, grid: { color: '#374151' }, ticks: { color: '#9ca3af', source: 'auto' } }, y: { grid: { color: '#374151' }, ticks: { color: '#9ca3af' }, min: 0, max: 200 } }, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } } }
                    });
                },
                
                openEventModal(t){this.state.currentEventType=t;const e=`<div class="grid grid-cols-2 gap-4"><div><label for="param-date" class="block text-gray-300 mb-1 font-semibold">Fecha</label><input type="date" id="param-date" class="w-full bg-base-300 rounded-lg px-4 py-3" required></div><div><label for="param-time" class="block text-gray-300 mb-1 font-semibold">Hora</label><input type="time" id="param-time" class="w-full bg-base-300 rounded-lg px-4 py-3" required></div></div>`,i={alcohol:{title:"Consumo de Alcohol",inputs:`<label class="font-semibold">N¬∫ de Bebidas</label><input type="number" id="param-cantidad" value="1" min="1" class="w-full bg-base-300 rounded-lg px-4 py-3" required>${e}`},modafinilo:{title:"Dosis de Modafinilo",inputs:`<label class="font-semibold">Dosis (mg)</label><input type="number" id="param-cantidad" value="100" step="50" min="50" class="w-full bg-base-300 rounded-lg px-4 py-3" required>${e}`},ejercicio:{title:"Sesi√≥n de Ejercicio",inputs:`<label class="font-semibold">Duraci√≥n (min)</label><input type="number" id="param-cantidad" value="30" step="10" min="10" class="w-full bg-base-300 rounded-lg px-4 py-3" required><label class="font-semibold">Intensidad</label><select id="param-intensidad" class="w-full bg-base-300 rounded-lg px-4 py-3"><option value="0.7">Baja</option><option value="1.0" selected>Media</option><option value="1.5">Alta</option></select>${e}`},porno:{title:"Consumo de Pornograf√≠a",inputs:`<label class="font-semibold">Duraci√≥n (min)</label><input type="number" id="param-cantidad" value="15" step="5" min="5" class="w-full bg-base-300 rounded-lg px-4 py-3" required>${e}`},cafeina:{title:"Consumo de Cafe√≠na",inputs:`<label class="font-semibold">N¬∫ de Tazas</label><input type="number" id="param-cantidad" value="1" min="1" class="w-full bg-base-300 rounded-lg px-4 py-3" required>${e}`},te:{title:"Consumo de T√©",inputs:`<label class="font-semibold">N¬∫ de Tazas</label><input type="number" id="param-cantidad" value="1" min="1" class="w-full bg-base-300 rounded-lg px-4 py-3" required>${e}`},azucar:{title:"Consumo de Az√∫car",inputs:`<label class="font-semibold">Intensidad</label><select id="param-intensidad" class="w-full bg-base-300 rounded-lg px-4 py-3"><option value="0.5">Baja</option><option value="1.0" selected>Media</option><option value="2.0">Alta</option></select>${e}`},sue√±o:{title:"Registro de Sue√±o",inputs:`<label class="font-semibold">Horas Dormidas</label><input type="number" id="param-cantidad" step="0.5" value="8" min="0" class="w-full bg-base-300 rounded-lg px-4 py-3" required><label class="font-semibold">Calidad del Sue√±o</label><select id="param-intensidad" class="w-full bg-base-300 rounded-lg px-4 py-3"><option value="0.5">Mala</option><option value="1.0" selected>Regular</option><option value="1.5">Buena</option></select>${e}`},hrv:{title:"Registro de HRV",inputs:`<label class="font-semibold">Valor HRV (ms)</label><input type="number" id="param-cantidad" value="55" min="10" class="w-full bg-base-300 rounded-lg px-4 py-3" required>${e}`},masturbacion:{title:"Sesi√≥n de Masturbaci√≥n",inputs:`<label class="font-semibold">Duraci√≥n (min)</label><input type="number" id="param-cantidad" value="10" step="5" min="5" class="w-full bg-base-300 rounded-lg px-4 py-3" required>${e}`},orgasmo:{title:"Registro de Orgasmo",inputs:e}};this.ui.eventModalTitle.textContent=i[t].title,this.ui.eventInputsContainer.innerHTML=i[t].inputs;const s=new Date;document.getElementById("param-date").valueAsDate=s,document.getElementById("param-time").value=s.toTimeString().slice(0,5),this.ui.eventModal.classList.add("flex"),this.ui.eventModal.classList.remove("hidden"),setTimeout(()=>this.ui.eventModal.querySelector(".modal-content").classList.remove("scale-95"),10)},
                
                closeEventModal(){this.ui.eventModal.querySelector(".modal-content").classList.add("scale-95"),setTimeout(()=>{this.ui.eventModal.classList.add("hidden"),this.ui.eventModal.classList.remove("flex")},300)},
                
                calculateFactors(){const{sexo:t,peso:e}=this.state.userProfile,i=Math.max(1,e);return{factorSexoAlcohol:"Mujer"===t?1.3:1,factorSexoModafiniloDuracionMultiplier:"Mujer"===t?1.2:1,factorPeso:75/i}},

                getEventEffect(event, factors, now) {
                    const startTime = new Date(event.startTime).getTime();
                    const minutesElapsed = (now - startTime) / 60000;
                    if (minutesElapsed < 0) return { effect: 0, finished: false };
                    let effectValue = 0;
                    let isFinished = false;
                    // El evento 'sue√±o' ya no tiene un efecto temporal directo, sino que resetea los eventos
                    // y afecta la l√≠nea base directamente al ser a√±adido.
                    const formulas = { alcohol: { duration: 360, apply: p => { const q = p.cantidad || 1, u = 8 * q * factors.factorSexoAlcohol * factors.factorPeso, d = -16 * q * factors.factorSexoAlcohol * factors.factorPeso; if (minutesElapsed < 60) return minutesElapsed / 60 * u; if (minutesElapsed < 180) return u + (minutesElapsed - 60) / 120 * (d - u); if (minutesElapsed < 360) return d * (1 - (minutesElapsed - 180) / 180); return 0; } }, modafinilo: { duration: 1020, apply: p => { const d = (p.cantidad || 100) / 100, pk = 35 * d * factors.factorPeso, pD = 660 * factors.factorSexoModafiniloDuracionMultiplier; if (minutesElapsed < 120) return minutesElapsed / 120 * pk; if (minutesElapsed < 120 + pD) return pk; if (minutesElapsed < 120 + pD + 240) return pk * (1 - (minutesElapsed - 120 - pD) / 240); return 0; } }, ejercicio: { duration: p => (p.cantidad || 30) + 120, apply: p => { const d = p.cantidad || 30, i = p.intensidad || 1, pk = 10 * i * factors.factorPeso, pD = Math.max(0, d - 15); if (minutesElapsed < 15) return minutesElapsed / 15 * pk; if (minutesElapsed < 15 + pD) return pk; if (minutesElapsed < 15 + pD + 120) return pk * (1 - (minutesElapsed - 15 - pD) / 120); return 0; } }, porno: { duration: p => (p.cantidad || 15) + 90, apply: p => { const d = p.cantidad || 15, u = 5 + d / 10, dn = -10; if (minutesElapsed < d) return minutesElapsed / d * u; if (minutesElapsed < d + 20) return u + (minutesElapsed - d) / 20 * (dn - u); if (minutesElapsed < d + 90) return dn * (1 - (minutesElapsed - d - 20) / 70); return 0; } }, cafeina: { duration: 240, apply: p => { const q = p.cantidad || 1, u = 20 * q, d = -5 * q; if (minutesElapsed < 30) return minutesElapsed / 30 * u; if (minutesElapsed < 90) return u + (minutesElapsed - 30) / 60 * (d - u); if (minutesElapsed < 240) return d * (1 - (minutesElapsed - 90) / 150); return 0; } }, te: { duration: 300, apply: p => { const q = p.cantidad || 1, u = 12 * q, d = -2 * q; if (minutesElapsed < 45) return minutesElapsed / 45 * u; if (minutesElapsed < 120) return u + (minutesElapsed - 45) / 75 * (d - u); if (minutesElapsed < 300) return d * (1 - (minutesElapsed - 120) / 180); return 0; } }, azucar: { duration: 120, apply: p => { const i = p.intensidad || 1, u = 25 * i, d = -15 * i; if (minutesElapsed < 15) return minutesElapsed / 15 * u; if (minutesElapsed < 45) return u + (minutesElapsed - 15) / 30 * (d - u); if (minutesElapsed < 120) return d * (1 - (minutesElapsed - 45) / 75); return 0; } }, sensacion: { duration: 60, apply: p => { const v = p.cantidad, pk = (v - 5) * 2.5; return minutesElapsed < 60 ? pk * (1 - minutesElapsed / 60) : 0; } }, sue√±o: { duration: 0, apply: p => 0 }, hrv: { duration: 180, apply: p => { const e = (p.cantidad - 55) * 0.3; return minutesElapsed < 180 ? e * (1 - minutesElapsed / 180) : 0; } }, masturbacion: { duration: p => (p.cantidad || 10) + 50, apply: p => { const d = p.cantidad || 10, u = 15, dn = -5; if (minutesElapsed < d) return minutesElapsed / d * u; if (minutesElapsed < d + 50) return u + (minutesElapsed - d) / 50 * (dn - u); return 0; } }, orgasmo: { duration: 150, apply: () => { const u = 40, d = -20; if (minutesElapsed < 3) return u; if (minutesElapsed < 15) return d; if (minutesElapsed < 150) return d * (1 - (minutesElapsed - 15) / 135); return 0; } } };
                    const formula = formulas[event.type];
                    if (formula) {
                        const totalDuration = typeof formula.duration === 'function' ? formula.duration(event.params) : formula.duration;
                        if (minutesElapsed > totalDuration) {
                            isFinished = true;
                            effectValue = 0;
                        } else {
                            effectValue = formula.apply(event.params);
                        }
                    }
                    return { effect: effectValue, finished: isFinished };
                },
                
                generateAllChartPoints() {
                    const factors = this.calculateFactors();
                    const baseLevel = this.state.userProfile.dynamicBaseLevel;
                    const now = new Date();
                    const twoDaysAgo = new Date(now);
                    twoDaysAgo.setDate(now.getDate() - 2);
                    twoDaysAgo.setHours(0, 0, 0, 0);
                    const startDate = twoDaysAgo.getTime();
                    const oneDayForward = new Date(now);
                    oneDayForward.setDate(now.getDate() + 1);
                    const endDate = oneDayForward.getTime();
                    
                    const allPoints = [];
                    const interval = 15 * 60 * 1000; 

                    for (let time = startDate; time <= endDate; time += interval) {
                        let totalEffect = 0;
                        this.state.events.forEach(event => {
                            totalEffect += this.getEventEffect(event, factors, time).effect;
                        });
                        totalEffect += this.calculateSleepDebt(time);
                        allPoints.push({ x: time, y: Math.round(baseLevel + totalEffect) });
                    }
                    return allPoints;
                },

                updateChart(allPoints) {
                    if (!this.state.chart || !allPoints) return;
                    try {
                        const now = new Date();
                        const historicalPoints = allPoints.filter(p => p.x <= now.getTime());
                        const forecastPoints = allPoints.filter(p => p.x >= now.getTime());
                        if (forecastPoints.length > 0 && historicalPoints.length > 0) {
                            forecastPoints.unshift(historicalPoints[historicalPoints.length-1]);
                        }

                        // Calculate 24-hour moving average
                        const movingAveragePoints = [];
                        const maWindow = 24 * 60 * 60 * 1000;
                        for(let i = 0; i < allPoints.length; i++) {
                            const currentPoint = allPoints[i];
                            const windowStart = currentPoint.x - maWindow;
                            const pointsInWindow = allPoints.filter(p => p.x >= windowStart && p.x <= currentPoint.x);
                            if (pointsInWindow.length > 0) {
                                const sum = pointsInWindow.reduce((acc, p) => acc + p.y, 0);
                                movingAveragePoints.push({ x: currentPoint.x, y: sum / pointsInWindow.length });
                            }
                        }

                        this.state.chart.data.datasets[0].data = historicalPoints;
                        this.state.chart.data.datasets[1].data = forecastPoints;
                        this.state.chart.data.datasets[2].data = movingAveragePoints;
                        
                        this.state.chart.update('none'); 
                    } catch (t) {
                        console.error("Error updating chart:", t);
                    }
                },
                
                attachEventListeners(){this.ui.profileForm.addEventListener("submit",t=>this.saveProfile(t)),this.ui.editProfileBtn.addEventListener("click",()=>this.ui.profileSetup.classList.remove("hidden")),document.querySelectorAll(".event-btn").forEach(t=>t.addEventListener("click",()=>this.openEventModal(t.dataset.event))),this.ui.eventForm.addEventListener("submit",t=>this.handleEventSubmit(t)),this.ui.cancelEventBtn.addEventListener("click",()=>this.closeEventModal()),this.ui.sensacionSlider.addEventListener("input",t=>{this.ui.sensacionValue.textContent=t.target.value}),this.ui.addSensacionBtn.addEventListener("click",()=>{const t=parseFloat(this.ui.sensacionSlider.value);this.addEvent("sensacion",{cantidad:t},new Date),this.ui.sensacionSlider.value=5,this.ui.sensacionValue.textContent="5"}),this.ui.analyzeGeminiBtn.addEventListener("click",()=>this.handleGeminiAnalysis()),this.ui.closeGeminiBtn.addEventListener("click",()=>{this.ui.geminiModal.classList.add("hidden"),this.ui.geminiModal.classList.remove("flex")}),this.ui.apiKeyForm.addEventListener("submit", e => { e.preventDefault(); const key = this.ui.apiKeyInput.value; if(key) localStorage.setItem('geminiApiKey_v10', key); this.ui.apiKeyModal.classList.add('hidden'); this.ui.apiKeyModal.classList.remove('flex'); this.handleGeminiAnalysis(); }), this.ui.cancelApiKeyBtn.addEventListener("click", () => {this.ui.apiKeyModal.classList.add('hidden'); this.ui.apiKeyModal.classList.remove('flex');})}
            };

            App.init();
        });
    </script>
</body>
</html>

